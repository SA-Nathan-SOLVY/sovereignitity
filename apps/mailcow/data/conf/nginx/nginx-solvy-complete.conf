# SOLVY Platform - Complete Nginx Configuration
# Deploy to: /etc/nginx/sites-available/solvy-complete
# Enable with: sudo ln -s /etc/nginx/sites-available/solvy-complete /etc/nginx/sites-enabled/

# ============================================
# MAIN SITE - nitty.ebl.beauty (SOLVY Platform)
# ============================================
server {
    listen 80;
    server_name nitty.ebl.beauty ebl.beauty www.ebl.beauty;
    
    root /var/www/solvy-platform;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # Enable gzip compression
    gzip on;
    gzip_types text/css application/javascript application/json image/svg+xml;
    gzip_comp_level 6;
    
    # Cache static assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|webp)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}

# ============================================
# DECIDEY NGO - decidey.ebl.beauty
# ============================================
server {
    listen 80;
    server_name decidey.ebl.beauty;
    
    root /var/www/solvy-platform;
    index decidey-ngo.html;
    
    location / {
        try_files $uri $uri/ /decidey-ngo.html;
    }
    
    # Enable gzip compression
    gzip on;
    gzip_types text/css application/javascript application/json;
}

# ============================================
# ADMIN DASHBOARD - admin.ebl.beauty
# ============================================
server {
    listen 80;
    server_name admin.ebl.beauty;
    
    root /var/www/solvy-platform;
    index admin-dashboard.html;
    
    # Basic authentication for admin access
    # Create password file: sudo htpasswd -c /etc/nginx/.htpasswd admin
    auth_basic "Admin Access Required";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    location / {
        try_files $uri $uri/ /admin-dashboard.html;
    }
}

# ============================================
# P2P FRONTEND - p2p.ebl.beauty
# ============================================
server {
    listen 80;
    server_name p2p.ebl.beauty;
    
    root /var/www/solvy-p2p-mvp/frontend/public;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Enable gzip compression
    gzip on;
    gzip_types text/css application/javascript application/json;
    
    # Cache static assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}

# ============================================
# P2P API - p2p-api.ebl.beauty
# ============================================
server {
    listen 80;
    server_name p2p-api.ebl.beauty;
    
    # Proxy to Node.js backend running on port 3002
    location / {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Rate limiting for API
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/m;
    limit_req zone=api_limit burst=20 nodelay;
}

# ============================================
# SHOP - shop.ebl.beauty (if exists)
# ============================================
server {
    listen 80;
    server_name shop.ebl.beauty;
    
    root /var/www/shop.ebl.beauty;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Enable gzip compression
    gzip on;
    gzip_types text/css application/javascript application/json;
}

# ============================================
# MAILCOW - mail.ebl.beauty (if exists)
# ============================================
server {
    listen 80;
    server_name mail.ebl.beauty;
    
    # Proxy to MailCow (if running on different port)
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ============================================
# IP ADDRESS ACCESS (for testing before DNS)
# ============================================
server {
    listen 80 default_server;
    server_name 46.62.235.95;
    
    root /var/www/solvy-platform;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # Enable gzip compression
    gzip on;
    gzip_types text/css application/javascript application/json;
}

# ============================================
# SECURITY HEADERS (Applied to all servers)
# ============================================
# Add these to each server block or use a separate config file

# Example security headers to add:
# add_header X-Frame-Options "SAMEORIGIN" always;
# add_header X-Content-Type-Options "nosniff" always;
# add_header X-XSS-Protection "1; mode=block" always;
# add_header Referrer-Policy "no-referrer-when-downgrade" always;

# ============================================
# DEPLOYMENT INSTRUCTIONS
# ============================================

# 1. Upload this file to Hetzner VPS:
#    scp nginx-solvy-complete.conf root@46.62.235.95:/etc/nginx/sites-available/solvy-complete

# 2. Create admin password file:
#    sudo htpasswd -c /etc/nginx/.htpasswd admin

# 3. Enable the site:
#    sudo ln -s /etc/nginx/sites-available/solvy-complete /etc/nginx/sites-enabled/

# 4. Test configuration:
#    sudo nginx -t

# 5. Reload Nginx:
#    sudo systemctl reload nginx

# 6. Add SSL certificates (after DNS is configured):
#    sudo certbot --nginx -d nitty.ebl.beauty -d decidey.ebl.beauty -d admin.ebl.beauty -d p2p.ebl.beauty -d p2p-api.ebl.beauty -d shop.ebl.beauty -d mail.ebl.beauty -d ebl.beauty -d www.ebl.beauty

# ============================================
# DNS RECORDS REQUIRED
# ============================================

# Add these A records in Hetzner DNS Console:
# @ (root)          A    46.62.235.95    300
# www               A    46.62.235.95    300
# nitty             A    46.62.235.95    300
# decidey           A    46.62.235.95    300
# admin             A    46.62.235.95    300
# p2p               A    46.62.235.95    300
# p2p-api           A    46.62.235.95    300
# shop              A    46.62.235.95    300
# mail              A    46.62.235.95    300

# ============================================
# NOTES
# ============================================

# - All HTTP (port 80) configurations above
# - After SSL setup, Certbot will auto-configure HTTPS (port 443)
# - P2P API backend must be running on port 3002 (use PM2)
# - Admin dashboard requires password authentication
# - Rate limiting configured for P2P API (100 requests/minute)
# - Gzip compression enabled for faster loading
# - Static asset caching configured (7 days)
